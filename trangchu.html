<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tạo bài viết mới</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <style>
      body {
        background-color: #f0f2f5;
      }
    </style>
  </head>
  <body>
    <div class="container mt-5">
      <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
          <button id="logout-btn" class="btn btn-danger">Đăng Xuất</button>
          <div class="card">
            <div class="card-header text-center">
              <h5>Tạo bài viết</h5>
            </div>
            <div class="card-body">
              <form id="post-form">
                <div class="d-flex align-items-center mb-3">
                  <i class="bi bi-person-circle fs-2 me-2"></i>
                  <span id="user-name" class="fw-bold"></span>
                </div>

                <div class="mb-3">
                  <textarea
                    class="form-control border-0"
                    id="post-content"
                    rows="4"
                    placeholder="Bạn đang nghĩ gì?"
                    required
                  ></textarea>
                </div>

                <div class="mb-3">
                  <input
                    type="text"
                    class="form-control"
                    id="post-image-url"
                    placeholder="up link ảnh vào đây"
                  />
                </div>

                <div class="d-grid">
                  <button
                    type="submit"
                    class="btn btn-primary"
                    id="submit-post"
                  >
                    Đăng bài
                  </button>
                </div>
              </form>
            </div>
          </div>
          <div class="mt-4" id="post-container">
            <!-- đổ dữ liệu vào đây -->
          </div>
        </div>
      </div>
    </div>
  </body>
  <script>
    // Lấy thông tin người dùng từ localStorage
    const loggedInUserJSON = localStorage.getItem("user");
    const submitButton = document.getElementById("submit-post");
    const postContent = document.getElementById("post-content");
    let currentUser = null;

    //  Kiểm tra đăng nhập và hiển thị tên
    if (loggedInUserJSON) {
      currentUser = JSON.parse(loggedInUserJSON);
      console.log(currentUser);
      document.getElementById("user-name").textContent = currentUser.username;
    } else {
      alert("Bạn cần đăng nhập để đăng bài!");
      window.location.href = "loggin.html";
    }
    // gửi dữ liệu từ form lên mockapi
    renderPost(); // render bài viết
    document
      .getElementById("post-form")
      .addEventListener("submit", function (e) {
        e.preventDefault();
        const url = "https://68766632814c0dfa653bf302.mockapi.io/post";

        const newPost = {
          content: postContent.value,
          imageUrl: document.getElementById("post-image-url").value,
          userId: currentUser.id, // Gắn ID của người dùng vào bài viết
          username: currentUser.username, // Gắn tên người dùng vào bài viết
          time: new Date().toLocaleDateString("vi-VN"), // Thêm thời gian tạo
          emotions: [],
        };
        console.log(newPost);
        // Gửi dữ liệu lên MockAPI
        fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(newPost),
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("Đăng bài thành công:", data);
            alert("Đăng bài thành công!");
            renderPost();
          })
          .catch((error) => {
            console.error("Lỗi:", error);
            alert("Đã có lỗi xảy ra, vui lòng thử lại.");
          });
      });
    function renderPost() {
      const postContainer = document.getElementById("post-container");
      fetch("https://68766632814c0dfa653bf302.mockapi.io/post")
        .then((response) => response.json())
        .then((posts) => {
          // Đảo ngược mảng để bài mới nhất lên đầu
          let UIpost = posts.reverse().map((post) => {
            let postHTML = `
                <div class="card mb-3">
                <div class="card-header bg-white border-0 p-3">
                    <div class="d-flex align-items-center">
                    <i class="bi bi-person-circle fs-2 me-2"></i>
                    <div>
                        <strong class="d-block">${post.username}</strong>
                        <small class="text-muted">${post.time}</small>
                    </div>
                    </div>
                </div>

                <div class="card-body pt-0">
                    <p class="card-text">${post.content}</p>
                </div>
                <img src="${post.imageUrl}" class="card-img-bottom" alt="Ảnh bài viết">

                <div class="card-footer bg-white border-0 p-3">
                    <div class="d-flex justify-content-around">
                    <button   class="btn btn-like btn-light w-100" onclick ="addLike(${post.id})">
                        <i class="bi bi-heart"></i> ${post.emotions.length}
                    </button>
                    <button class="btn btn-light w-100" onclick="removePostIndex(${post.id},${post.userId})">
                        <i class="bi bi-x-circle-fill" >Xóa</i>
                    </button>

                    </div>
                </div>
                </div>
            `;

            return postHTML;
          });
          postContainer.innerHTML = UIpost.join("");
        })
        .catch((error) => console.error("Lỗi:", error));
    }
    function removePostIndex(id, userId) {
      console.log("check xóa");
      // Kiểm tra xem người dùng có trùng với người post bài lên không
      if (currentUser.id == userId) {
        fetch(`https://68766632814c0dfa653bf302.mockapi.io/post/${id}`, {
          method: "DELETE",
        })
          .then((response) => response.json())
          .then(() => {
            alert("Xóa bài viết thành công!");
            renderPost();
          })
          .catch((error) => console.error("Lỗi:", error));
      } else {
        alert("Bạn không có quyền xóa bài viết này!");
      }
    }

    // Lắng nghe sự kiện click trên nút đăng xuất
    document
      .getElementById("logout-btn")
      .addEventListener("click", function () {
        // 1. Xóa thông tin người dùng khỏi localStorage
        localStorage.removeItem("loggedInUser"); // Hoặc 'user' tùy theo khóa bạn đã dùng

        // 2. Thông báo và chuyển hướng về trang đăng nhập
        alert("Bạn đã đăng xuất thành công!");
        window.location.href = "loggin.html";
      });

    // chuyển biểu tượng thành số lượng like
    function addLike(postId) {
      //b1: lấy dữ liệu về
      fetch(`https://68766632814c0dfa653bf302.mockapi.io/post/${postId}`)
        .then((response) => response.json())
        .then((data) => {
          //b2: lấy mảng biểu tượng
          let listEmotions = data.emotions;
          let order = {
            userId: currentUser.id,
            username: currentUser.username,
          };
          listEmotions.push(order);
          let numberLike = listEmotions.length;
          //b3: gửi dữ liệu lên mockapi
          fetch(`https://68766632814c0dfa653bf302.mockapi.io/post/${postId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              emotions: listEmotions,
            }),
          })
            .then((response) => response.json())
            .then(() => {
              alert("Like bài viết thanh cong!");
              renderPost();
            })
            .catch((error) => console.error("Lỗi:", error));
        });

      console.log("check like");
      let detail = {
        userId: currentUser.id,
        username: currentUser.username,
      };
      listEmotions.push(order);
      let numberLike = listEmotions.length;
      fetch(`https://68766632814c0dfa653bf302.mockapi.io/post/${postId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          emotions: listEmotions,
        }),
      })
        .then((response) => response.json())
        .then(() => {
          alert("Like bài viết thanh cong!");
          renderPost();
        })
        .catch((error) => console.error("Lỗi:", error));
    }
  </script>
</html>
